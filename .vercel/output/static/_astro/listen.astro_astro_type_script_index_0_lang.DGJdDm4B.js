document.documentElement.style.setProperty("--fadeTime","3000ms");const w=document.getElementById("info-hud"),k=document.getElementById("works-hud"),A=document.getElementById("spectrogram-container"),P=document.getElementById("modal"),X=document.getElementById("help"),_=document.getElementById("helpToggle"),E=document.getElementById("spectrogram"),V=E.getContext("2d"),tt=document.getElementById("playhead"),y=document.getElementById("time-display"),L=[...k.querySelectorAll("li")];let f,h,p,u,T=0,x=!1,N=0,j=0,b=!1,$,F=!1,S=0,Y=0;function et(t){return t?(Array.isArray(t)?t:[t]).map(o=>o.replace(/\[\[|\]\]/g,"").trim()).join(", "):""}function nt(t){return t?.match(/^(\d{4})/)?.[1]||""}function l(t){t.classList.add("visible")}function d(t){t.classList.remove("visible")}function ot(t){return new Promise(e=>setTimeout(e,t))}function at(t){const e=Math.floor(t/60),o=Math.floor(t%60);return`${e}:${o.toString().padStart(2,"0")}`}function z(){E.width=window.innerWidth,E.height=window.innerHeight*.4,u&&O(u)}window.addEventListener("resize",z);document.addEventListener("fullscreenchange",z);function G(t){w.innerHTML=`
    ${t.dataset.work}<br>
    ${t.dataset.desc}<br>
    ${et(JSON.parse(t.dataset.perf||"null"))}<br>    
    ${t.dataset.event}<br>
    ${t.dataset.venue}, ${t.dataset.city}, ${t.dataset.country}<br>
    ${nt(t.dataset.date)}
  `}async function B(){f||(f=new AudioContext,h=f.createGain(),h.gain.value=0,h.connect(f.destination),console.log("Audio context created, gain set to 0"))}function q(){if(!(!p||!f||!u)){S=f.currentTime-Y,S=Math.max(0,Math.min(S,u.duration));try{p.stop()}catch{}try{p.disconnect()}catch{}p=null,F=!1,$&&($.textContent="PLAY"),console.log("Source stopped, isPlaying:",F)}}async function U(t){if(console.log("Fading to gain:",t),!f)return;const e=f.currentTime;h.gain.cancelScheduledValues(e),h.gain.setValueAtTime(h.gain.value,e),h.gain.linearRampToValueAtTime(t,e+3e3/1e3),await ot(3e3),console.log("Fade complete, current gain:",h.gain.value)}async function W(){console.log("PANIC"),b=!0,await B(),await U(0),q()}function ct(){N&&cancelAnimationFrame(N),N=0}function it(t){console.log("Starting playhead with offset:",t);const e=f.currentTime-t,o=()=>{if(!p||!u)return;const a=f.currentTime-e,c=a/u.duration*100;tt.style.left=`${c}%`;const v=at(a);y.textContent=v,c>=80?(y.style.left=`${c}%`,y.style.transform="translateX(0)"):(y.style.left=`${c}%`,y.style.transform="translateX(-50%)"),N=requestAnimationFrame(o)};o()}function lt(t,e){return .5-.5*Math.cos(2*Math.PI*t/(e-1))}function rt(t,e){const o=t.length;let a=0;for(let n=0;n<o;n++){n<a&&([t[n],t[a]]=[t[a],t[n]],[e[n],e[a]]=[e[a],e[n]]);let c=o>>1;for(;c>=1&&a>=c;)a-=c,c>>=1;a+=c}for(let n=2;n<=o;n<<=1){const c=-2*Math.PI/n,v=Math.cos(c),I=Math.sin(c);for(let r=0;r<o;r+=n){let m=1,g=0;for(let s=0;s<n/2;s++){const M=t[r+s],i=e[r+s],D=t[r+s+n/2]*m-e[r+s+n/2]*g,H=t[r+s+n/2]*g+e[r+s+n/2]*m;t[r+s]=M+D,e[r+s]=i+H,t[r+s+n/2]=M-D,e[r+s+n/2]=i-H;const C=m*v-g*I;g=m*I+g*v,m=C}}}}function O(t){const e=E.width,o=E.height;V.clearRect(0,0,e,o);const a=2048,n=a>>1,c=t.getChannelData(0),v=Math.max(1,Math.floor((c.length-a)/e)),I=new Array(a),r=new Array(a),m=new Float32Array(n);for(let g=0;g<e;g++){const s=g*v;if(s+a>=c.length)break;for(let i=0;i<a;i++)I[i]=c[s+i]*lt(i,a),r[i]=0;rt(I,r);let M=1e-9;for(let i=0;i<n;i++)m[i]=Math.hypot(I[i],r[i]),m[i]>M&&(M=m[i]);for(let i=0;i<o;i++){const D=Math.floor(i/o*n),H=Math.log10(1+9*(m[D]/M)),C=Math.floor(H*255);V.fillStyle=`rgb(${C},${C},${C})`,V.fillRect(g,o-i-1,1,1)}}}async function J(t){console.log("Loading buffer for file:",t);const e=await fetch("/audio/"+encodeURIComponent(t));return f.decodeAudioData(await e.arrayBuffer())}function K(t=0){if(!b){console.log("BLOCKING playback: user has not interacted yet");return}console.log("Starting playback with offset:",t,"current gain:",h.gain.value),q(),ct(),p=f.createBufferSource(),p.buffer=u,p.connect(h),Y=f.currentTime-t,p.start(0,t),F=!0,$&&($.textContent="PAUSE"),it(t)}async function Q(){u&&(F?(console.log("Pausing playback"),await U(0),q()):(console.log("Starting playback from togglePlayPause"),b=!0,await B(),K(S||0),await U(1)))}async function R(t){if(t<0||t>=L.length)return;const e=++j,o=L[t];if(L[T]?.classList.remove("selected"),T=t,o.classList.add("selected"),o.scrollIntoView({behavior:"smooth",block:"center"}),G(o),await B(),F&&(console.log("Stopping current track during track change"),await U(0),q()),d(w),d(k),d(A),e===j){try{u=await J(o.dataset.audio)}catch(a){console.error("Failed to load audio:",a),l(w),l(k);return}e===j&&(S=0,O(u),l(w),l(k),l(A))}}function Z(){if(P.classList.contains("visible")){d(P);return}P.innerHTML="";const t=L[T].querySelector(".modal-content");t&&(P.innerHTML=t.innerHTML),l(P)}L.forEach((t,e)=>t.onclick=()=>{console.log("Track clicked, index:",e),b=!0,R(e)});E.onclick=t=>{if(console.log("Canvas clicked"),b=!0,!u)return;const e=E.getBoundingClientRect(),o=(t.clientX-e.left)/e.width*u.duration;K(Math.max(0,o))};document.addEventListener("click",()=>{b||(console.log("First user interaction detected"),b=!0,B())},{once:!0});document.addEventListener("keydown",t=>{t.code==="Space"&&(t.preventDefault(),console.log("Space pressed, toggling play/pause"),b=!0,Q()),t.key==="p"&&(t.preventDefault(),W()),t.key==="ArrowUp"&&R(T-1),t.key==="ArrowDown"&&R(T+1),t.key==="i"&&Z(),t.key==="m"&&(x=!x,x?(d(w),d(k),d(A),d(y)):(l(w),l(k),l(A),l(y))),t.key==="f"&&(document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()),t.key==="Escape"&&(P.classList.contains("visible")?d(P):location.href="/"),t.key==="?"&&X.classList.toggle("visible")});_.onclick=()=>X.classList.toggle("visible");function st(){if(!("maxTouchPoints"in navigator&&navigator.maxTouchPoints>0))return;const e=document.getElementById("shortcut-buttons");e.classList.add("visible");const o={"↑":()=>R(T-1),"↓":()=>R(T+1),PLAY:()=>Q(),PANIC:()=>W(),i:()=>Z(),m:()=>{x=!x,x?(d(w),d(k),d(A),d(y)):(l(w),l(k),l(A),l(y))},f:()=>document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()};for(const[a,n]of Object.entries(o)){const c=document.createElement("button");c.textContent=a,a==="PLAY"&&($=c),c.onclick=v=>{v.preventDefault(),b=!0,B(),n()},e.appendChild(c)}}async function ut(){console.log("Initializing audio player"),await B(),z();const t=L[T];G(t);try{u=await J(t.dataset.audio),S=0,O(u),console.log("Initial track loaded, no auto-playback")}catch(e){console.error("Failed to load initial audio:",e)}l(w),l(k),l(A),st()}ut();
