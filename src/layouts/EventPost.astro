---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';

type Props = CollectionEntry<'events'>['data'];

const {
    dates,
    work,
    performedBy,
    eventName,
    venue,
    city,
    country,
    url
} = Astro.props;

const slugify = (text: string) => text.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '');
const parseWikilink = (link: string) => link.replace(/\[\[|\]\]/g, '');

const performersArray = Array.isArray(performedBy) ? performedBy : [performedBy];

const getVenueName = (venueString: string) => {
    const match = venueString.match(/(.*?)\s*\((https?:\/\/[^\)]+)\)/);
    return match ? match[1].trim() : venueString;
};

const getVenueUrl = (venueString: string) => {
    const match = venueString.match(/(.*?)\s*\((https?:\/\/[^\)]+)\)/);
    return match ? match[2] : null;
};
---

<html lang="en" data-theme="dark">
	<head>
		<BaseHead title={eventName} description={`Event: ${eventName}`} />
     
	</head>

	<body>
		<Header />
		<main>
			<div class="layout-wrapper">
				<aside class="sidebar">
					<div class="title">
						<h1>{eventName}</h1>
					</div>
					
					<hr />

                    <div class="meta-section">
                        <h3>Work</h3>
                        <p><a href={`/works/${slugify(work)}`}>{work}</a></p>
                    </div>

                    <div class="meta-section">
                        <h3>Dates</h3>
                        <ul>
                            {dates.map(d => (
                                <li>
                                    <FormattedDate date={d.date} />{d.hour ? ` at ${d.hour}` : ''}
                                </li>
                            ))}
                        </ul>
                    </div>

                    {performersArray.length > 0 && (
                        <div class="meta-section">
                            <h3>Performers</h3>
                            <ul>
                                {performersArray.map(performer => {
                                    const performerName = parseWikilink(performer);
                                    const performerSlug = slugify(performerName);
                                    // simple check if performer exists
                                    return <li><a href={`/performers/${performerSlug}`}>{performerName}</a></li>
                                })}
                            </ul>
                        </div>
                    )}

                    <div class="meta-section">
                        <h3>Venue</h3>
                        <p>{getVenueName(venue)}</p>
                        <p>{city}, {country}</p>
                        {getVenueUrl(venue) && (
                            <p class="venue-url"><a href={getVenueUrl(venue)} target="_blank"  rel="noopener noreferrer">Venue Website</a></p>
                        )}
                        {url && <p class="venue-url"><a href={url} target="_blank" rel="noopener noreferrer">Event Info</a></p>}
                    </div>

				</aside>

				<article class="main-content">
					<div class="prose">
						<slot />
					</div>
				</article>
			</div>
		</main>
		<Footer />
	</body>
</html>
