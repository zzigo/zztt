---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';

type Props = CollectionEntry<'research'>['data'];

const { title, description, pubDate, updatedDate, heroImage, doi, isbn, bibtex } = Astro.props;

// Format date to show year only if no specific date
const formatPublicationDate = (date: Date) => {
	const dateStr = date.toISOString();
	// Check if it's just a year (January 1st indicates year-only date)
	if (dateStr.startsWith(`${date.getFullYear()}-01-01`)) {
		return date.getFullYear().toString();
	}
	return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
};
---

<html lang="en" class="dark">
	<head>
		<BaseHead title={title} description={description} />
		<style>
			body {
				background-color: #2a2a2a;
			}
			main {
				width: calc(100% - 2em);
				max-width: 100%;
				margin: 0;
				background-color: #2a2a2a;
				color: #e0e0e0;
			}
			.hero-image {
				width: 100%;
			}
			.hero-image img {
				display: block;
				margin: 0 auto;
				border-radius: 12px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
			}
			.prose {
				width: 720px;
				max-width: calc(100% - 2em);
				margin: auto;
				padding: 1em;
				color: #e0e0e0;
			}
			.title {
				margin-bottom: 1em;
				padding: 1em 0;
				text-align: center;
				line-height: 1.3;
			}
			.title h1 {
				margin: 0 0 0.5em 0;
				color: #ffffff;
				font-size: 2.5rem;
				font-weight: 400;
			}
			.description {
				margin: 1em 0;
				padding: 1em;
				background-color: #333333;
				border-left: 3px solid #4a9eff;
				font-style: italic;
				color: #c0c0c0;
				line-height: 1.6;
			}
			.metadata {
				background-color: #333333;
				border-radius: 8px;
				padding: 1.5em;
				margin: 1.5em 0;
				font-family: 'Courier New', monospace;
				font-size: 0.9rem;
			}
			.metadata-item {
				margin: 0.75em 0;
				display: flex;
				flex-wrap: wrap;
				gap: 0.5em;
			}
			.metadata-label {
				font-weight: 400;
				color: #4a9eff;
				min-width: 120px;
			}
			.metadata-value {
				color: #e0e0e0;
				flex: 1;
			}
			.doi-link {
				color: #4a9eff;
				text-decoration: none;
				transition: color 0.2s ease;
			}
			.doi-link:hover {
				color: #6bb5ff;
				text-decoration: underline;
			}
			.bibtex-container {
				background-color: #1a1a1a;
				border-radius: 6px;
				padding: 1em;
				margin-top: 0.5em;
				overflow-x: auto;
			}
			.bibtex-content {
				color: #a0a0a0;
				white-space: pre-wrap;
				word-break: break-all;
				line-height: 1.5;
			}
			.pub-date {
				font-size: 1.1rem;
				color: #999;
				margin-bottom: 0.5em;
			}
			.last-updated-on {
				font-style: italic;
				color: #888;
				font-size: 0.9rem;
			}
			hr {
				border: none;
				border-top: 1px solid #444;
				margin: 1.5em 0;
			}
		</style>
	</head>

	<body>
		<Header />
		<main>
			<article>
				{heroImage && (
					<div class="hero-image">
						<img 
							width={1020} 
							height={510} 
							src={heroImage} 
							alt={title}
							loading="lazy"
							style="max-width: 100%; height: auto;"
						/>
					</div>
				)}
				<div class="prose">
					<div class="title">
						<h1>{title}</h1>
						
						{description && (
							<div class="description">
								{description}
							</div>
						)}

						{pubDate && (
							<div class="pub-date">
								{formatPublicationDate(pubDate)}
							</div>
						)}
						
						{updatedDate && (
							<div class="last-updated-on">
								Last updated: <FormattedDate date={updatedDate} />
							</div>
						)}
					</div>

					{(doi || isbn || bibtex) && (
						<div class="metadata">
							<h3 style="margin-top: 0; color: #ffffff;">Publication Metadata</h3>
							
							{doi && (
								<div class="metadata-item">
									<span class="metadata-label">DOI:</span>
									<span class="metadata-value">
										<a href={`https://doi.org/${doi}`} target="_blank" rel="noopener noreferrer" class="doi-link">
											{doi}
										</a>
									</span>
								</div>
							)}

							{isbn && (
								<div class="metadata-item">
									<span class="metadata-label">ISBN:</span>
									<span class="metadata-value">{isbn}</span>
								</div>
							)}

							{bibtex && (
								<div class="metadata-item">
									<span class="metadata-label">BibTeX:</span>
									<div class="metadata-value">
										<div class="bibtex-container">
											<pre class="bibtex-content">{bibtex}</pre>
										</div>
									</div>
								</div>
							)}
						</div>
					)}

					<hr />
					
					<slot />
				</div>
			</article>
		</main>
		<Footer />
	</body>
</html>
