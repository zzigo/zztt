---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';

type Props = CollectionEntry<'research'>['data'];

const { title, description, pubDate, updatedDate, heroImage, doi, isbn, bibtex, paperURL, codeURL, url } = Astro.props;

// Format date to show year only if no specific date
const formatPublicationDate = (date: Date) => {
	const dateStr = date.toISOString();
	// Check if it's just a year (January 1st indicates year-only date)
	if (dateStr.startsWith(`${date.getFullYear()}-01-01`)) {
		return date.getFullYear().toString();
	}
	return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
};
---

<html lang="en" class="dark">
	<head>
		<BaseHead title={title} description={description} />
		<style>
			body {
				background-color: #2a2a2a;
			}
			main {
				width: calc(100% - 2em);
				max-width: 100%;
				margin: 0;
				background-color: #000000;
				color: #e0e0e0;
			}
			.hero-image {
				width: 100%;
			}
			.hero-image img {
				display: block;
				margin: 0 auto;
				border-radius: 12px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
			}
			.prose {
				width: 720px;
				max-width: calc(100% - 2em);
				margin: auto;
				padding: 1em;
				color: #e0e0e0;
			}
			.title {
				margin-bottom: 1em;
				padding: 1em 0;
				text-align: center;
				line-height: 1.3;
			}
			.title h1 {
				margin: 0 0 0.5em 0;
				color: #ffffff;
				font-size: 2.5rem;
				font-weight: 100;
			}
			.description {
				margin: 1em 0;
				padding: 1em;
				background-color: #333333;
				border-left: 3px solid #4a9eff;
				font-style: italic;
				color: #c0c0c0;
				line-height: 1.6;
			}
			.metadata {
				background-color: #333333;
				border-radius: 8px;
				padding: 1.5em;
				margin: 1.5em 0;
				font-family: 'Courier New', monospace;
				font-size: 0.9rem;
			}
			.metadata-item {
				margin: 0.75em 0;
				display: flex;
				flex-wrap: wrap;
				gap: 0.5em;
			}
			.metadata-label {
				font-weight: 400;
				color: #4a9eff;
				min-width: 120px;
			}
			.metadata-value {
				color: #e0e0e0;
				flex: 1;
			}
			.doi-link {
				color: #4a9eff;
				text-decoration: none;
				transition: color 0.2s ease;
			}
			.doi-link:hover {
				color: #6bb5ff;
				text-decoration: underline;
			}
			.bibtex-container {
				background-color: #1a1a1a;
				border-radius: 6px;
				padding: 1em;
				margin-top: 0.5em;
				overflow-x: auto;
			}
			.bibtex-content {
				color: #a0a0a0;
				white-space: pre-wrap;
				word-wrap: break-word;
				overflow-wrap: break-word;
				line-height: 1.5;
			}
			.pub-date {
				font-size: 1.1rem;
				color: #999;
				margin-bottom: 0.5em;
			}
			.last-updated-on {
				font-style: italic;
				color: #888;
				font-size: 0.9rem;
			}
			hr {
				border: none;
				border-top: 1px solid #444;
				margin: 1.5em 0;
			}
			
			.pre.astro-code.github-dark {
				white-space: normal !important;			
			}
		</style>
	</head>

	<body>
		<Header />
		<main>
			<article>
				{heroImage && (
					<div class="hero-image">
						<img 
							width={1020} 
							height={510} 
							src={heroImage} 
							alt={title}
							loading="lazy"
							style="max-width: 100%; height: auto;"
						/>
					</div>
				)}
				<div class="prose">
					<div class="title">
						<h1>{title}</h1>
						
						{description && (
							<div class="description">
								{description}
							</div>
						)}

						{pubDate && (
							<div class="pub-date">
								{formatPublicationDate(pubDate)}
							</div>
						)}
						
						{updatedDate && (
							<div class="last-updated-on">
								Last updated: <FormattedDate date={updatedDate} />
							</div>
						)}
					</div>

					{(doi || isbn || bibtex || paperURL || codeURL || url) && (
						<div class="metadata">
							<h3 style="margin-top: 0; color: #ffffff;">Publication Metadata</h3>
							
							{doi && (
								<div class="metadata-item">
									<span class="metadata-label">DOI:</span>
									<span class="metadata-value">
										<a href={`https://doi.org/${doi}`} target="_blank" rel="noopener noreferrer" class="doi-link">
											{doi}
										</a>
									</span>
								</div>
							)}

							{isbn && (
								<div class="metadata-item">
									<span class="metadata-label">ISBN:</span>
									<span class="metadata-value">{isbn}</span>
								</div>
							)}

							{bibtex && (
								<div class="metadata-item">
									<span class="metadata-label">BibTeX:</span>
									<div class="metadata-value">
										<div class="bibtex-container">
											<pre class="bibtex-content">{bibtex}</pre>
										</div>
									</div>
								</div>
							)}

							{paperURL && (
								<div class="metadata-item">
									<span class="metadata-label">Paper:</span>
									<span class="metadata-value">
										<a href={paperURL} target="_blank" rel="noopener noreferrer" class="doi-link">
											ðŸ“„ View Paper
										</a>
									</span>
								</div>
							)}

							{codeURL && (
								<div class="metadata-item">
									<span class="metadata-label">Code:</span>
									<span class="metadata-value">
										<a href={codeURL} target="_blank" rel="noopener noreferrer" class="doi-link">
											<svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
												<path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
											</svg>
											{codeURL}
										</a>
									</span>
								</div>
							)}

							{url && (
								<div class="metadata-item">
									<span class="metadata-value" style="flex: 1 1 100%;">
										<a href={url} target="_blank" rel="noopener noreferrer" class="doi-link">
											{url}
										</a>
									</span>
								</div>
							)}
						</div>
					)}

					<hr />
					
					<slot />
				</div>
			</article>
		</main>
		<Footer />
	</body>
</html>
