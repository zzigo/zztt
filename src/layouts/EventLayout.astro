---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';

type Props = CollectionEntry<'events'>['data'];

const { title, description, dates, venue, city, country, work, performers, heroImage } = Astro.props as Props;

const slugify = (text: string) => text.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '');
const parseWikilink = (link: string) => link.replace(/\[\[|\]\]/g, '');

const parseVenue = (venueString: string) => {
    const match = venueString.match(/^(.*)\((.*)\)$/);
    if (match) {
        return { name: match[1].trim(), url: match[2].trim() };
    }
    return { name: venueString, url: null };
};
const venueInfo = parseVenue(venue);
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
		<style>
			main {
				width: calc(100% - 2em);
				max-width: 100%;
				margin: 0;
				margin-top: 3rem;
				padding: 1em;
				background-color: var(--background);
				color: var(--text);
			}
			.layout-wrapper {
				display: flex;
				flex-direction: column;
				gap: 2em;
				padding-top: 8rem;
			}
			.sidebar {
				width: 100%;
				flex-shrink: 0;
			}
			.main-content {
				flex-grow: 1;
				min-width: 0; /* Prevents overflow issues in flex children */
			}

			@media (min-width: 768px) {
				.layout-wrapper {
					flex-direction: row;
				}
				.sidebar {
					width: 280px;
				}
			}

			.sidebar .title {
				text-align: left;
				margin-bottom: 1em;
			}

			.sidebar h1 {
				margin: 0 0 0.25em 0;
				line-height: 1.1;
			}

			.sidebar .description {
				font-style: italic;
				color: var(--text-muted);
			}

			.meta-section {
				margin-top: 1.5em;
			}

			.meta-section h3 {
				font-size: 0.9em;
				text-transform: uppercase;
				color: var(--text-muted);
				border-bottom: 1px solid var(--accent);
				padding-bottom: 0.3em;
				margin-bottom: 0.5em;
			}

			.meta-section ul, .meta-section p {
				list-style: none;
				padding: 0;
				margin: 0;
				font-size: 0.95em;
			}

			.meta-section a {
				color: var(--text);
				text-decoration: underline;
				text-decoration-color: var(--accent);
			}
			.meta-section a:hover {
				color: var(--accent);
			}

			.hero-image {
				width: 100%;
				margin-bottom: 2em;
			}
			.hero-image img {
				display: block;
				margin: 0 auto;
				border-radius: 12px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
			}
			.prose {
				width: 100%;
				max-width: 720px; /* Keep prose readable */
				margin: 0;
				padding: 0;
				color: var(--text);
			}
			
			.dates-list li {
				margin-bottom: 0.25rem;
			}
		</style>
	</head>

	<body>
		<script>
			// Theme initialization script
			const theme = (() => {
				if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
					return localStorage.getItem('theme') || 'light';
				}
				if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
					return 'dark';
				}
				return 'light';
			})();

			if (theme === 'light') {
				document.documentElement.classList.remove('dark');
			} else {
				document.documentElement.classList.add('dark');
			}

			window.localStorage.setItem('theme', theme);
		</script>
		<Header />
		<main>
			{heroImage && (
				<div class="hero-image">
					<img 
						width={1020} 
						height={510} 
						src={heroImage} 
						alt={title}
						loading="lazy"
						style="max-width: 100%; height: auto;"
					/>
				</div>
			)}
			<div class="layout-wrapper">
				<aside class="sidebar">
					<div class="title">
						<h1>{title}</h1>
						{description && <p class="description">{description}</p>}
					</div>

					<hr />

                    <div class="meta-section">
                        <h3>Dates</h3>
                        <ul class="dates-list">
                            {dates.map(({ date, hour }) => (
                                <li>
                                    <FormattedDate date={new Date(date)} />
                                    {hour && ` at ${hour}`}
                                </li>
                            ))}
                        </ul>
                    </div>

                    <div class="meta-section">
                        <h3>Location</h3>
                        <p>
                            {venueInfo.url ? <a href={venueInfo.url} target="_blank" rel="noopener noreferrer">{venueInfo.name}</a> : venueInfo.name}
                            <br/>
                            {city}, {country}
                        </p>
                    </div>

                    {work && (
                        <div class="meta-section">
                            <h3>{Array.isArray(work) && work.length > 1 ? 'Works' : 'Work'}</h3>
                            {(Array.isArray(work) ? work : [work]).map(w => {
                                const workName = parseWikilink(w);
                                const workSlug = slugify(workName);
                                return <p><a href={`/works/${workSlug}`}>{workName}</a></p>
                            })}
                        </div>
                    )}

					{performers && performers.length > 0 && (
						<div class="meta-section">
							<h3>Performers</h3>
							<ul>
								{performers.map(performer => {
									const performerName = parseWikilink(performer);
									const performerSlug = slugify(performerName);
									// A check could be added here to see if the performer page exists
									return <li><a href={`/performers/${performerSlug}`}>{performerName}</a></li>
								})}
							</ul>
						</div>
					)}
				</aside>

				<article class="main-content">
					<div class="prose">
						<slot />
					</div>
				</article>
			</div>
		</main>
		<Footer />
	</body>
</html>
