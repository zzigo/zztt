---
import { getCollection } from 'astro:content';

const posts = await getCollection('events');
const audioPosts = posts.filter(p => p.data.audio);
---
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Listen</title>

<style>
  body {
    margin: 0;
    background: black;
    color: white;
    font-family: monospace;
    overflow: hidden;
  }

  #spectrogram {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 50vh;
  }

  #works-hud {
    position: fixed;
    top: 55vh;
    left: 20px;
    opacity: 0.8;
  }

  #works-hud ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  #works-hud li {
    cursor: pointer;
    padding: 4px 0;
  }

  #works-hud li.selected {
    background: rgba(255,255,255,0.2);
  }

  #info-hud {
    position: fixed;
    bottom: 20px;
    left: 20px;
    opacity: 0.7;
  }

  #exit {
    position: fixed;
    top: 10px;
    right: 20px;
    font-size: 2em;
    color: white;
    text-decoration: none;
    opacity: 0.5;
  }
</style>
</head>

<body>

<a id="exit" href="/">&times;</a>

<canvas id="spectrogram"></canvas>

<div id="works-hud">
  <ul>
    {audioPosts.map((post, i) => (
      <li
        class={i === 0 ? 'selected' : ''}
        data-audio={post.data.audio}
        data-performedby={post.data.performedBy?.[0]}
        data-event={post.data.eventName}
        data-venue={post.data.venue}
        data-city={post.data.city}
        data-country={post.data.country}
        data-date={post.data.dates?.[0]}
      >
        {post.data.title}
      </li>
    ))}
  </ul>
</div>

<div id="info-hud"></div>

<script>
const works = document.querySelectorAll('#works-hud li');
const infoHud = document.getElementById('info-hud');
const canvas = document.getElementById('spectrogram');
const ctx = canvas.getContext('2d');

let audioContext;
let analyser;
let source;
let selected = 0;

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight * 0.5;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

function parseWikilink(s) {
  return s ? s.replace(/\[\[|\]\]/g, '') : '';
}

function parseDateSafe(dateStr) {
  if (!dateStr) return null;

  if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
    return new Date(dateStr);
  }

  if (/^\d{2}-\d{2}-\d{4}$/.test(dateStr)) {
    const [dd, mm, yyyy] = dateStr.split('-');
    return new Date(`${yyyy}-${mm}-${dd}`);
  }

  return null;
}

function updateHUD(el) {
  const dateObj = parseDateSafe(el.dataset.date);
  const date = dateObj
    ? dateObj.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      })
    : '';

  infoHud.innerHTML = `
    ${parseWikilink(el.dataset.performedby)}<br>
    ${el.dataset.event || ''}<br>
    ${el.dataset.venue || ''}${el.dataset.city ? ', ' + el.dataset.city : ''}${el.dataset.country ? ', ' + el.dataset.country : ''}<br>
    ${date}
  `;
}

async function play(index) {
  const el = works[index];
  if (!el) return;

  works[selected]?.classList.remove('selected');
  selected = index;
  el.classList.add('selected');
  updateHUD(el);

  if (!audioContext) {
    audioContext = new AudioContext();
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;
  }

  if (audioContext.state === 'suspended') {
    await audioContext.resume();
  }

  if (source) {
    source.stop();
    source.disconnect();
  }

  const audioPath = encodeURI(`/audio/${el.dataset.audio}`);
  const res = await fetch(audioPath);

  if (!res.ok) {
    console.error('Audio fetch failed:', res.status);
    return;
  }

  const buf = await res.arrayBuffer();
  if (!buf.byteLength) {
    console.error('Empty audio buffer');
    return;
  }

  const audioBuffer = await audioContext.decodeAudioData(buf);

  source = audioContext.createBufferSource();
  source.buffer = audioBuffer;
  source.connect(analyser);
  analyser.connect(audioContext.destination);
  source.start();

  drawSpectrogram();
}

function drawSpectrogram() {
  const freqData = new Uint8Array(analyser.frequencyBinCount);
  const width = canvas.width;
  const height = canvas.height;

  ctx.fillStyle = 'black';
  ctx.fillRect(0, 0, width, height);

  function frame() {
    analyser.getByteFrequencyData(freqData);

    const imageData = ctx.getImageData(1, 0, width - 1, height);
    ctx.putImageData(imageData, 0, 0);

    for (let y = 0; y < height; y++) {
      const idx = Math.floor((y / height) * freqData.length);
      const val = freqData[idx];
      ctx.fillStyle = `rgb(${val},${val},${val})`;
      ctx.fillRect(width - 1, height - y, 1, 1);
    }
    requestAnimationFrame(frame);
  }
  frame();
}

works.forEach((el, i) => el.onclick = () => play(i));

document.addEventListener('keydown', e => {
  if (e.key === 'ArrowUp') play(selected - 1);
  if (e.key === 'ArrowDown') play(selected + 1);
  if (e.key === 'Escape') location.href = '/';
});

if (works.length) play(0);
</script>

</body>
</html>