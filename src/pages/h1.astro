---
import { getCollection } from "astro:content";
import { SITE_TITLE } from "../consts";
import { ViewTransitions } from 'astro:transitions';

const posts = (await getCollection("works"))
  .filter(w => w.data.status !== "upcoming");

const colA = posts.filter((_, i) => i % 2 === 0);
const colB = posts.filter((_, i) => i % 2 !== 0);
---

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<ViewTransitions />

<style>
html, body {
  margin: 0;
  height: 100%;
}

body {
  overflow: hidden;
  font-family: system-ui, sans-serif;
}

.viewport {
  position: fixed;
  inset: 0;
  transition: transform 0.3s ease-in-out;
  view-transition-name: viewport;
}

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  height: 100%;
}

.column {
  overflow-y: auto;
  overscroll-behavior: contain;
    /* hide scrollbars */
  scrollbar-width: none;          /* Firefox */
  -ms-overflow-style: none;       /* IE 10+ */
}

.column::-webkit-scrollbar {
  display: none;                  /* Chrome, Safari, Edge */
}

.entry {
  position: relative;
}

.entry img {
  width: 100%;
  display: block;
}

.entry-info {
  position: absolute;
  inset: 0;
  padding: 1rem;
  background: rgba(0,0,0,0.6);
  color: white;
  opacity: 0;
  transition: opacity 0.25s;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  pointer-events: none;
}

.entry:hover .entry-info {
  opacity: 1;
}

.entry a {
  display: block;
}

@media (max-width: 768px) {
  .grid {
    grid-template-columns: 1fr;
  }
  .col-b {
    display: none;
  }
}

nav {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  z-index: 100;
  padding: 1rem;
  display: flex;
  justify-content: space-between;
  color: #fff;
  mix-blend-mode: difference;
  font-size: 1.3rem;
}

nav a {
  color: inherit;
  text-decoration: none;
}

.sidebar {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  height: 100vh;
  height: calc(100vh - env(safe-area-inset-bottom));
  width: 300px;
  background: #111;
  z-index: 200;
  padding: 14px 15px;
  transform: translateX(100%);
  border-left: 1px solid #333;
  view-transition-name: sidebar;
  text-align: left;
  font-size: 1rem;
  letter-spacing: 1px;
  word-spacing: 1px;
  -webkit-font-smoothing: antialiased;
  backface-visibility: hidden;
  overflow-y: auto;
  transition: transform 0.3s ease-in-out;
}

.sidebar * {
  backface-visibility: hidden;
}

body.menu-open .sidebar {
  transform: translateX(0);
}

body.menu-open .viewport {
  transform: translateX(-300px);
}
</style>
</head>

<body>
<nav>
  <a href="/">{SITE_TITLE}</a>
  <div style="display: flex; gap: 1rem;">
    <a href="/about">About</a>
    <a href="#" onclick="toggleMenu(event)">Menu</a>
  </div>
</nav>

<div class="sidebar">
  <a href="#" onclick="toggleMenu(event)" style="display:block; margin-bottom: 2rem; font-size: 1.5rem;">&times; Close</a>
  <ul style="list-style: none; padding: 0;">
    <li style="margin-bottom: 1rem;"><a href="/">Home</a></li>
    <li style="margin-bottom: 1rem;"><a href="/works">Works</a></li>
    <li style="margin-bottom: 1rem;"><a href="/about">About</a></li>
  </ul>
</div>

<div class="viewport">
  <div class="grid">
    <div class="column col-a">
      {colA.map(post => (
        <div class="entry">
          <a href={`/works/${post.slug}/`}>
            <img src={post.data.heroImage} alt={post.data.title} loading="lazy">
          </a>
          <div class="entry-info">
            <h3>
              {post.data.title}
              <span style="font-size: 0.6em; opacity: 0.6;">({post.data.pubDate.getFullYear()})</span>
            </h3>
            <p>{post.data.description}</p>
          </div>
        </div>
      ))}
    </div>

    <div class="column col-b">
      {colB.map(post => (
        <div class="entry">
          <a href={`/works/${post.slug}/`}>
            <img src={post.data.heroImage} alt={post.data.title} loading="lazy">
          </a>
          <div class="entry-info">
            <h3>
              {post.data.title}
              <span style="font-size: 0.6em; opacity: 0.6;">({post.data.pubDate.getFullYear()})</span>
            </h3>
            <p>{post.data.description}</p>
          </div>
        </div>
      ))}
    </div>
  </div>
</div>

<script>
window.toggleMenu = (e) => {
  if (e) e.preventDefault();
  
  if (document.startViewTransition) {
    document.startViewTransition(() => {
      document.body.classList.toggle('menu-open');
    });
  } else {
    document.body.classList.toggle('menu-open');
  }
};

const colA = document.querySelector('.col-a');
const colB = document.querySelector('.col-b');

let active = null;
let raf = null;

function lerp(a, b, t) {
  return a + (b - a) * t;
}

function sync() {
  if (!active) return;

  if (active === colA) {
    colB.scrollTop = lerp(colB.scrollTop, colA.scrollTop * 0.7, 0.12);
  } else {
    colA.scrollTop = lerp(colA.scrollTop, colB.scrollTop * 1.3, 0.12);
  }

  raf = requestAnimationFrame(sync);
}

function start(col) {
  active = col;
  if (!raf) raf = requestAnimationFrame(sync);
}

function stop() {
  active = null;
  cancelAnimationFrame(raf);
  raf = null;
}

colA.addEventListener('pointerenter', () => start(colA));
colB.addEventListener('pointerenter', () => start(colB));

colA.addEventListener('pointerleave', stop);
colB.addEventListener('pointerleave', stop);
</script>
</body>
</html>