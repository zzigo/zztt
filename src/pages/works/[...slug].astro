---
import { type CollectionEntry, getCollection, render } from 'astro:content';
import BlogPost from '../../layouts/BlogPost.astro';
import ContentGallery from '../../components/ContentGallery.jsx';

export async function getStaticPaths() {
    const posts = await getCollection('works');
    const paths = [];

    for (const post of posts) {
        const uniqueSlugs = new Set();
        
        // 1. Astro's slug (from filename, lowercase, dasherized)
        uniqueSlugs.add(post.slug);

        // 2. Slug from Title (to handle different casing)
        const titleSlug = post.data.title.replace(/\s+/g, '-');
        uniqueSlugs.add(titleSlug); // e.g., The-Entanglement
        uniqueSlugs.add(titleSlug.toLowerCase()); // e.g., the-entanglement

        for (const slug of uniqueSlugs) {
            paths.push({
                params: { slug },
                props: post,
            });
        }
    }

    return paths;
}

type Props = CollectionEntry<'works'>;
const post = Astro.props;
const { Content } = await render(post);

// --- UTILIDADES ---
const slugify = (text: string) => text.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '');
const parseWikilink = (link: string) => link.replace(/\[\[|\]\]/g, '').trim();

const formatDate = (date: Date) => {
    return date.toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
    });
};

// Get all events and filter for the current work.
const allEvents = await getCollection('events');
const relatedEvents = allEvents.filter(event => {
    const eventWork = event.data.work;
    const currentWorkTitle = post.data.title;
    if (Array.isArray(eventWork)) {
        return eventWork.includes(currentWorkTitle);
    }
    return eventWork === currentWorkTitle;
});

// Get unique performers from the related events.
const uniquePerformers = new Set<string>();
for (const event of relatedEvents) {
    if (event.data.performedBy) {
        const performers = Array.isArray(event.data.performedBy) ? event.data.performedBy : [event.data.performedBy];
        for (const performer of performers) {
            uniquePerformers.add(parseWikilink(performer));
        }
    }
}
const performedByArray = Array.from(uniquePerformers);

// Create the flattened list of dated events for display.
const workEvents = relatedEvents
    .flatMap(event => (event.data.dates || []).map(d => ({
        title: event.data.eventName,
        city: event.data.city,
        date: d.date,
        slug: event.slug
    })))
    .sort((a, b) => b.date.valueOf() - a.date.valueOf());
---

<BlogPost {...post.data}>
    
    <div slot="sidebar" class="sticky-sidebar-container">
        
        {performedByArray.length > 0 && (
            <div class="meta-section">
                <h3>Performed By</h3>
                <ul class="meta-list performers-list">
                    {performedByArray.map(name => (
                        <li>
                            <a href={`/performers/${slugify(name)}`}>{name}</a>
                        </li>
                    ))}
                </ul>
            </div>
        )}

        {workEvents.length > 0 && (
            <div class="meta-section">
                <h3>History & Events</h3>
                <ul class="meta-list events-list">
                    {workEvents.map(event => (
                        <li>
                            <a href={`/events/${event.slug}`}>
                                <strong>{event.title}</strong>
                            </a>
                            <div class="event-meta">
                                {event.city} — {formatDate(event.date)}
                            </div>
                        </li>
                    ))}
                </ul>
            </div>
        )}
    </div>

    <Content />
    
    <div class="gallery-container">
        <ContentGallery client:load />
    </div>

</BlogPost>

<style>
    /* --- LÓGICA STICKY --- */
    @media (min-width: 768px) {
        .sticky-sidebar-container {
            position: sticky;
            /* Ajusta este valor según la altura de tu Nav/Header */
            top: 5rem; 
            /* Evita que el sidebar sea más alto que la pantalla y sea inaccesible */
            max-height: calc(100vh - 6rem);
            overflow-y: auto;
            /* Escondemos la scrollbar para mantener la estética minimalista */
            scrollbar-width: none; 
        }
        .sticky-sidebar-container::-webkit-scrollbar {
            display: none;
        }
    }

    .meta-section {
        margin-top: 2rem;
    }

    .meta-section:first-child {
        margin-top: 0;
    }

    .meta-section h3 {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-muted);
        border-bottom: 1px solid var(--accent);
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }

    .meta-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .meta-list li {
        line-height: 1.2;
        padding-left: 0;
    }

    .performers-list li {
        margin-bottom: 0.3rem;
    }

    .events-list li {
        margin-bottom: 1.2rem;
    }

    .meta-list a {
        text-decoration: none;
        color: var(--text);
        font-size: 0.95rem;
        transition: all 0.2s;
    }

    .meta-list a:hover {
        color: var(--accent);
    }

    .event-meta {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 0.2rem;
        font-style: italic;
    }

    .gallery-container {
        margin-top: 5rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border, #333);
    }
</style>