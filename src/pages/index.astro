---
// THEME CONFIG
const DEFAULT_THEME = "dark"; // "dark" | "light"
const REDIRECT_TO_ZZTT_HTML = false; //REDIRECT
const ENABLE_HERO_HEADER = true; //HERO HEADER

import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import Hero from "../components/hero.astro";
import { getCollection } from "astro:content";

const posts = (await getCollection("works"))
	.filter((work) => work.data.status !== "upcoming")
	.sort((a, b) => {
		if (a.data.pubDate && b.data.pubDate) {
			return b.data.pubDate.valueOf() - a.data.pubDate.valueOf();
		}
		return a.data.title.localeCompare(b.data.title);
	});

---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		{REDIRECT_TO_ZZTT_HTML && (
			<meta http-equiv="refresh" content="0;url=/zztt.html" />
		)}
		<style>
			body {
				background-color: var(--background);
				color: var(--text);
				overflow-y: auto;
			}
			.hero-container {
				height: 100vh;
				width: 100%;
				position: relative;
				top: 0;
				left: 0;
			}
			main {
				color: var(--text);
				padding: 1rem;
				max-width: 1200px;
				margin: 0 auto;
				position: relative;
				z-index: 1;
				background: linear-gradient(
					to bottom,
					transparent 0%,
					var(--background) 300px
				);
			}
			.intro {
				font-size: 1rem;
				margin-bottom: 4rem;
				text-align: center;
			}
			.works-section {
				margin-top: 4rem;
			}
			.works-grid {
				display: grid;
				gap: 2rem;
				list-style-type: none;
				margin: 0;
				padding: 0;
			}
			.work-item {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 2rem;
				align-items: center;
			}
			.work-item:nth-child(even) {
				direction: rtl;
			}
			.work-item:nth-child(even) .work-content {
				direction: ltr;
			}
			.work-image {
				width: 100%;
				height: auto;
				border-radius: 12px;
				transition: transform 0.3s ease;
			}
			.work-image:hover {
				transform: scale(1.02);
			}
			.work-content {
				display: flex;
				flex-direction: column;
				gap: 0.5rem;
			}
			.work-title {
				/* font-size: 1.5rem; */
				margin: 0 0 0rem 0;
				color: var(--text);
				font-weight: 400;
			}
			.work-date {
				color: var(--text-muted);
				font-size: 1rem;
				margin: 0;
			}
			.work-synopsis {
				color: var(--text-muted);
				line-height: 1.6;
				opacity: 50%;
				margin: 0;
			}
			a {
				color: inherit;
				text-decoration: none;
			}
			@media (max-width: 768px) {
				.work-item {
					grid-template-columns: 1fr;
					gap: 1rem;
				}
				.work-item:nth-child(even) {
					direction: ltr;
				}
				.work-image-container,
				.work-image {
					height: auto;
				}
				.work-image {
					object-fit: cover;
					width: 100%;
				}
			}
			h4.title {
				color: var(--text);
			}
		</style>
	</head>
	<body>
	<script>
(() => {
  const storedTheme = localStorage.getItem("theme");

  if (storedTheme === "light") {
    document.documentElement.classList.add("light");
  } else {
    document.documentElement.classList.remove("light");
    localStorage.removeItem("theme"); // keep storage clean
  }
})();
</script>

		{!REDIRECT_TO_ZZTT_HTML && (
			<>
				<Header />
				{ENABLE_HERO_HEADER && (
					<div class="hero-container">
						<Hero />
					</div>
				)}
				<main>
					<p class="intro">
						site under construction.
					</p>
					<section class="works-section">
						<ul class="works-grid">
							{
								posts.map((post) => (
									<li class="work-item">
										<a
											href={`/works/${post.id.replace(/\.md$/, '')}/`}
											class="work-image-container"
										>
											<img
												width={600}
												height={300}
												src={post.data.heroImage}
												alt=""
												class="work-image"
											/>
										</a>
										<div class="work-content">
											<a href={`/works/${post.id.replace(/\.md$/, '')}/`}>
												<h2 class="work-title">
													{post.data.title}
													<span style="font-size: 0.6em; opacity: 0.6;">({post.data.pubDate.getFullYear()})</span>
												</h2>
											</a>
											<p class="work-synopsis">
												{post.data.description}
											</p>
										</div>
									</li>
								))
							}
						</ul>
					</section>
				</main>
				<Footer />
			</>
		)}
		
		{!REDIRECT_TO_ZZTT_HTML && (
			<script>
				// Create a function to initialize audio context with user interaction
				const initAudioContext = async () => {
					try {
						// Create a new AudioContext
						const audioContext = new AudioContext();

						// Create a silent audio buffer
						const buffer = audioContext.createBuffer(1, 1, 22050);
						const source = audioContext.createBufferSource();
						source.buffer = buffer;
						source.connect(audioContext.destination);
						source.start(0);

						console.log(
							"AudioContext initialized:",
							audioContext.state,
						);

						// Wait a small amount of time to ensure AudioContext is ready
						await new Promise((resolve) => setTimeout(resolve, 100));

						// Dispatch a custom event to notify hero.astro that it can start
						window.dispatchEvent(new CustomEvent("audioContextReady"));

						return true;
					} catch (error) {
						console.error("Error initializing AudioContext:", error);
						return false;
					}
				};

				// Add event listeners for user interaction
				const handleUserInteraction = async () => {
					console.log("User interaction detected");
					
					// Initialize audio context
					const success = await initAudioContext();
					
					if (success) {
						// Remove event listeners after successful initialization
						document.removeEventListener("click", handleUserInteraction);
						document.removeEventListener("touchstart", handleUserInteraction);
						document.removeEventListener("keydown", handleUserInteraction);
					}
				};

				// Add event listeners for user interaction
				document.addEventListener("click", handleUserInteraction);
				document.addEventListener("touchstart", handleUserInteraction);
				document.addEventListener("keydown", handleUserInteraction);

				// Handle scroll-based audio fade
				let lastScrollY = 0;
				let ticking = false;

				const handleScroll = () => {
					lastScrollY = window.scrollY;
					
					if (!ticking) {
						window.requestAnimationFrame(() => {
							// Hero is 100vh, start fading at 80vh and fully fade by 100vh
							const heroHeight = window.innerHeight;
							const fadeStartPoint = heroHeight * 0.8;
							const fadeEndPoint = heroHeight;
							
							let volumeFactor = 1.0; // 1.0 = full volume, 0.0 = silent
							
							if (lastScrollY < fadeStartPoint) {
								// In hero area - full volume
								volumeFactor = 1.0;
							} else if (lastScrollY >= fadeEndPoint) {
								// Past hero - silent
								volumeFactor = 0.0;
							} else {
								// In fade zone - interpolate
								const fadeProgress = (lastScrollY - fadeStartPoint) / (fadeEndPoint - fadeStartPoint);
								volumeFactor = 1.0 - fadeProgress; // Linear fade from 1.0 to 0.0
							}
							
							// Dispatch event to hero component with volume factor
							window.dispatchEvent(new CustomEvent("scrollVolumeChange", {
								detail: { volumeFactor }
							}));
							
							ticking = false;
						});
						
						ticking = true;
					}
				};

				// Add scroll listener
				window.addEventListener("scroll", handleScroll, { passive: true });
		
			</script>
		)}
	</body>
</html>
